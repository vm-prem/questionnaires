<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bias & Fairness Questionnaire</title>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --accent: #2563eb;
      --req: #dc2626;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      line-height: 1.35;
    }
    header {
      padding: 28px 18px 16px;
      max-width: 980px;
      margin: 0 auto;
    }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .subtitle { margin: 0; color: var(--muted); font-size: 14px; }
    .container { max-width: 980px; margin: 0 auto; padding: 0 18px 60px; }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      margin-top: 14px;
    }
    .banner {
      background: linear-gradient(180deg, rgba(37,99,235,0.10), rgba(37,99,235,0.03));
      border: 1px solid rgba(37,99,235,0.18);
    }
    .section-title {
      font-size: 16px;
      margin: 0 0 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--line);
    }
    .q {
      padding: 14px 0;
      border-bottom: 1px dashed var(--line);
    }
    .q:last-child { border-bottom: none; }
    label.title {
      display: block;
      font-weight: 650;
      margin-bottom: 6px;
    }
    .req {
      color: var(--req);
      font-weight: 700;
      margin-left: 2px;
    }
    .help {
      color: var(--muted);
      font-size: 13px;
      margin: 0 0 10px;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 880px) {
      .row.two { grid-template-columns: 1fr 1fr; }
      .row.three { grid-template-columns: 1fr 1fr 1fr; }
    }

    input[type="text"], textarea, select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: #fff;
      outline: none;
    }
    textarea { min-height: 96px; resize: vertical; }
    input[type="text"]:focus, textarea:focus, select:focus {
      border-color: rgba(37,99,235,0.55);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.14);
    }

    .checks {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      padding: 6px 0 2px;
    }
    @media (min-width: 880px) {
      .checks.cols2 { grid-template-columns: 1fr 1fr; }
      .checks.cols3 { grid-template-columns: 1fr 1fr 1fr; }
    }
    .check {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fafafa;
    }
    .check input { margin-top: 3px; }
    .check span { font-size: 14px; }

    .small {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .footerbar {
      position: sticky;
      bottom: 0;
      margin-top: 18px;
      padding: 12px 14px;
      border-top: 1px solid var(--line);
      background: rgba(247,247,251,0.92);
      backdrop-filter: blur(10px);
    }
    .footerbar .inner {
      max-width: 980px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
      padding: 0 18px;
    }
    button {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 650;
      cursor: pointer;
      font-size: 14px;
    }
    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    button:active { transform: translateY(1px); }
    .status {
      margin-right: auto;
      color: var(--muted);
      font-size: 13px;
    }

    .pill {
      display: inline-block;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(37,99,235,0.10);
      border: 1px solid rgba(37,99,235,0.20);
      color: #1e3a8a;
      margin-left: 8px;
      vertical-align: middle;
    }
    .hr {
      border: none;
      border-top: 1px solid var(--line);
      margin: 14px 0 0;
    }
  
    /* Simulated (auto-filled) answers appear in blue ink */
    .simulated-answer { color: #2563eb !important; }
    label.simulated-answer span { color: #2563eb !important; }

  
    /* PDF capture mode: hide controls and ensure text wraps nicely */
    body.pdf-mode #status,
    body.pdf-mode #saveBtn,
    body.pdf-mode #clearBtn,
    body.pdf-mode button[type="submit"] {
      display: none !important;
      visibility: hidden !important;
    }
    body.pdf-mode textarea {
      overflow: visible !important;
      white-space: pre-wrap !important;
      word-break: break-word !important;
    }

  </style>
</head>

<body>
  <header>
    <h1>Bias & Fairness Questionnaire <span class="pill">Model Owner Submission Form</span></h1>
    <p class="subtitle">
      Document how bias and fairness risks are identified, assessed, mitigated, monitored, and governed for AI / GenAI / Agentic AI systems.
      Responses must reflect <b>current, implemented practices</b> (not aspirational intent).
    </p>
  </header>

  <div class="container">
    <form id="bf-form">
      <div class="card banner">
        <p class="help" style="margin:0;">
          <b>Instructions:</b> Complete all required fields (<span class="req">*</span>).
          Provide concise, evidence-based answers. Do not paste sensitive data. Use “Evidence references” fields to link to internal artifacts.
        </p>
      </div>

      <!-- A -->
      <div class="card">
        <h2 class="section-title">A. Fairness Objectives, Scope & Stakeholders</h2>

        <div class="q">
          <label class="title">A1. Fairness Objective(s) <span class="req">*</span></label>
          <p class="help">Select all that apply and briefly explain why fairness analysis is required for this model.</p>

          <div class="checks cols2">
            <label class="check"><input type="checkbox" name="A1_objectives" value="Fair lending / anti-discrimination compliance"><span>Compliance with fair lending / anti-discrimination requirements</span></label>
            <label class="check"><input type="checkbox" name="A1_objectives" value="Disparate impact prevention"><span>Prevention of disparate impact on protected or vulnerable groups</span></label>
            <label class="check"><input type="checkbox" name="A1_objectives" value="Ethical use beyond legal minimum"><span>Ethical use of AI beyond minimum legal requirements</span></label>
            <label class="check"><input type="checkbox" name="A1_objectives" value="Customer / consumer protection"><span>Customer or consumer protection</span></label>
            <label class="check"><input type="checkbox" name="A1_objectives" value="Reputational risk"><span>Reputational risk management</span></label>
            <label class="check"><input type="checkbox" name="A1_objectives" value="Regulatory / audit expectations"><span>Regulatory, supervisory, or audit expectations</span></label>
            <label class="check"><input type="checkbox" name="A1_objectives" value="Internal risk appetite"><span>Internal risk appetite or governance standards</span></label>
            <label class="check"><input type="checkbox" id="A1_other_chk" name="A1_objectives" value="Other"><span>Other (describe below)</span></label>
          </div>

          <div class="row two" style="margin-top:10px;">
            <div>
              <label class="title">A1 (Free-text). Objective Rationale <span class="req">*</span></label>
              <textarea name="A1_rationale" required placeholder="1–5 sentences explaining why fairness analysis is needed given the model’s purpose, decision context, and affected populations."></textarea>
            </div>
            <div>
              <label class="title">A1 (Optional). Other Objective</label>
              <textarea name="A1_other_text" placeholder="If 'Other' selected above, describe it here."></textarea>
            </div>
          </div>
        </div>

        <div class="q">
          <label class="title">A2. Impacted Stakeholders & Populations <span class="req">*</span></label>
          <p class="help">Select all groups potentially impacted by model outcomes.</p>

          <div class="checks cols3">
            <label class="check"><input type="checkbox" name="A2_groups" value="Retail customers"><span>Retail customers</span></label>
            <label class="check"><input type="checkbox" name="A2_groups" value="Commercial customers"><span>Commercial customers</span></label>
            <label class="check"><input type="checkbox" name="A2_groups" value="Consumers / applicants"><span>Consumers / applicants</span></label>
            <label class="check"><input type="checkbox" name="A2_groups" value="Employees / internal users"><span>Employees / internal users</span></label>
            <label class="check"><input type="checkbox" name="A2_groups" value="Third parties"><span>Third parties</span></label>
            <label class="check"><input type="checkbox" name="A2_groups" value="Affected individuals"><span>Affected individuals subject to automated or AI-assisted decisions</span></label>
            <label class="check"><input type="checkbox" name="A2_groups" value="Regulators / supervisors"><span>Regulators / supervisors</span></label>
          </div>

          <label class="title" style="margin-top:10px;">A2 (Free-text). Impact Description <span class="req">*</span></label>
          <textarea name="A2_impact" required placeholder="Describe how each selected group may be affected by biased or unfair outcomes."></textarea>
        </div>

        <div class="q">
          <label class="title">A3. Decision Criticality & Harm Potential <span class="req">*</span></label>
          <p class="help">How consequential are decisions informed or made by this model if bias or unfairness is present?</p>

          <select name="A3_criticality" required>
            <option value="" selected disabled>-- select --</option>
            <option>Low (informational only; minimal impact)</option>
            <option>Moderate (influences decisions; human review expected)</option>
            <option>High (material customer/consumer impact; limited review)</option>
            <option>Very High (automated or near-automated consequential decisions)</option>
          </select>

          <p class="small">Tip: Consider legal, financial, access, privacy, safety, and reputational harms.</p>
        </div>
      </div>

      <!-- B -->
      <div class="card">
        <h2 class="section-title">B. Data Representativeness & Bias Risk Identification</h2>

        <div class="q">
          <label class="title">B1. Training & Input Data Representativeness <span class="req">*</span></label>
          <p class="help">How representative is the data used to train, fine-tune, prompt, or operate the model of the relevant population?</p>

          <select name="B1_repr" required>
            <option value="" selected disabled>-- select --</option>
            <option>Highly representative (validated coverage; minimal gaps)</option>
            <option>Mostly representative (some known gaps; mitigations in place)</option>
            <option>Partially representative (material gaps; residual risk remains)</option>
            <option>Unknown / not assessed</option>
          </select>

          <label class="title" style="margin-top:10px;">B1 (Free-text). Representativeness Assessment <span class="req">*</span></label>
          <textarea name="B1_assess" required placeholder="Describe known gaps, skews, exclusions, or differences between training/operating data and the intended population."></textarea>
        </div>

        <div class="q">
          <label class="title">B2. Sensitive Attributes & Proxies Identified? <span class="req">*</span></label>
          <p class="help">Have sensitive attributes (e.g., race, gender, age) or potential proxy variables been identified and assessed?</p>

          <select name="B2_sensitive" required>
            <option value="" selected disabled>-- select --</option>
            <option>Yes (identified and assessed; controls implemented)</option>
            <option>Partially (identified; assessment or controls incomplete)</option>
            <option>No (not identified/assessed)</option>
            <option>Not applicable (explain)</option>
          </select>

          <label class="title" style="margin-top:10px;">B2 (Free-text). Sensitive Attributes & Proxies <span class="req">*</span></label>
          <textarea name="B2_detail" required placeholder="List sensitive attributes considered (as applicable) and potential proxies. Explain how direct or indirect use is managed."></textarea>
        </div>

        <div class="q">
          <label class="title">B3. Known Sources of Bias Considered? <span class="req">*</span></label>
          <p class="help">Select all sources of bias that have been explicitly assessed.</p>

          <div class="checks cols2">
            <label class="check"><input type="checkbox" name="B3_sources" value="Historical / societal bias"><span>Historical / societal bias</span></label>
            <label class="check"><input type="checkbox" name="B3_sources" value="Sampling / selection bias"><span>Sampling or selection bias</span></label>
            <label class="check"><input type="checkbox" name="B3_sources" value="Measurement / labeling bias"><span>Measurement or labeling bias</span></label>
            <label class="check"><input type="checkbox" name="B3_sources" value="Proxy bias"><span>Proxy bias</span></label>
            <label class="check"><input type="checkbox" name="B3_sources" value="Feedback loop / reinforcement bias"><span>Feedback loop / reinforcement bias</span></label>
            <label class="check"><input type="checkbox" name="B3_sources" value="Prompt-induced bias (GenAI)"><span>Prompt-induced bias (GenAI)</span></label>
            <label class="check"><input type="checkbox" name="B3_sources" value="Agent behavior bias (tool selection, delegation, sequencing)"><span>Agent behavior bias (tool selection, delegation, sequencing)</span></label>
            <label class="check"><input type="checkbox" id="B3_other_chk" name="B3_sources" value="Other"><span>Other (describe below)</span></label>
          </div>

          <div class="row two" style="margin-top:10px;">
            <div>
              <label class="title">B3 (Free-text). Summary of Bias Risk Identification <span class="req">*</span></label>
              <textarea name="B3_summary" required placeholder="Summarize key bias risks identified and how they were evaluated."></textarea>
            </div>
            <div>
              <label class="title">B3 (Optional). Other Bias Source</label>
              <textarea name="B3_other_text" placeholder="If 'Other' selected above, describe it here."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- C -->
      <div class="card">
        <h2 class="section-title">C. Fairness Definitions & Metrics</h2>

        <div class="q">
          <label class="title">C1. Fairness Definition(s) Applied <span class="req">*</span></label>
          <p class="help">Select all fairness concepts used to evaluate this model.</p>

          <div class="checks cols2">
            <label class="check"><input type="checkbox" name="C1_defs" value="Demographic parity"><span>Demographic parity</span></label>
            <label class="check"><input type="checkbox" name="C1_defs" value="Equal opportunity"><span>Equal opportunity</span></label>
            <label class="check"><input type="checkbox" name="C1_defs" value="Equalized odds"><span>Equalized odds</span></label>
            <label class="check"><input type="checkbox" name="C1_defs" value="Individual fairness"><span>Individual fairness</span></label>
            <label class="check"><input type="checkbox" name="C1_defs" value="Counterfactual fairness"><span>Counterfactual fairness</span></label>
            <label class="check"><input type="checkbox" name="C1_defs" value="Human-centered / qualitative fairness assessment"><span>Human-centered or qualitative fairness assessment</span></label>
            <label class="check"><input type="checkbox" id="C1_other_chk" name="C1_defs" value="Other"><span>Other (describe below)</span></label>
          </div>

          <div class="row two" style="margin-top:10px;">
            <div>
              <label class="title">C1 (Free-text). Rationale for Selected Definitions <span class="req">*</span></label>
              <textarea name="C1_rationale" required placeholder="Explain why these fairness definitions are appropriate for the model’s decision context and risks."></textarea>
            </div>
            <div>
              <label class="title">C1 (Optional). Other Fairness Definition</label>
              <textarea name="C1_other_text" placeholder="If 'Other' selected above, describe it here."></textarea>
            </div>
          </div>
        </div>

        <div class="q">
          <label class="title">C2. Fairness Metrics & Thresholds <span class="req">*</span></label>
          <p class="help">Are quantitative or qualitative fairness metrics defined with thresholds or tolerance levels?</p>

          <select name="C2_defined" required>
            <option value="" selected disabled>-- select --</option>
            <option>Yes (metrics + thresholds defined and approved)</option>
            <option>Metrics defined (thresholds not finalized)</option>
            <option>Partially (limited metrics; gaps remain)</option>
            <option>No (not defined)</option>
          </select>

          <label class="title" style="margin-top:10px;">C2 (Free-text). Metrics & Thresholds <span class="req">*</span></label>
          <textarea name="C2_detail" required placeholder="Describe metrics used, thresholds applied, population(s) tested, and rationale for selection."></textarea>
        </div>

        <div class="q">
          <label class="title">C3. Population Segmentation <span class="req">*</span></label>
          <p class="help">At what level is fairness assessed?</p>

          <div class="checks cols2">
            <label class="check"><input type="checkbox" name="C3_scope" value="Global population only"><span>Global population only</span></label>
            <label class="check"><input type="checkbox" name="C3_scope" value="Key sub-segments (region/product/channel)"><span>Key sub-segments (e.g., region, product, channel)</span></label>
            <label class="check"><input type="checkbox" name="C3_scope" value="Protected class analysis"><span>Protected class analysis</span></label>
            <label class="check"><input type="checkbox" name="C3_scope" value="Intersectional analysis"><span>Intersectional analysis</span></label>
            <label class="check"><input type="checkbox" name="C3_scope" value="Scenario/use-case specific analysis"><span>Scenario-based or use-case-specific analysis</span></label>
          </div>

          <label class="title" style="margin-top:10px;">C3 (Free-text). Segmentation Approach <span class="req">*</span></label>
          <textarea name="C3_detail" required placeholder="Explain segmentation choices, coverage, and any exclusions/limitations."></textarea>
        </div>
      </div>

      <!-- D -->
      <div class="card">
        <h2 class="section-title">D. Testing, Monitoring & Stability</h2>

        <div class="q">
          <label class="title">D1. Fairness Testing Performed? <span class="req">*</span></label>
          <p class="help">Has fairness testing been conducted using appropriate data, scenarios, or simulations?</p>

          <select name="D1_tested" required>
            <option value="" selected disabled>-- select --</option>
            <option>Yes (comprehensive testing completed)</option>
            <option>Partially (limited testing completed)</option>
            <option>No (not tested)</option>
            <option>Not applicable (explain)</option>
          </select>

          <label class="title" style="margin-top:10px;">D1 (Free-text). Testing Summary <span class="req">*</span></label>
          <textarea name="D1_summary" required placeholder="Describe tests performed, datasets/scenarios used, and key findings. Include how GenAI prompts/agent behavior were tested if applicable."></textarea>
        </div>

        <div class="q">
          <label class="title">D2. Stability Over Time & Context <span class="req">*</span></label>
          <p class="help">How stable are fairness outcomes across time, data drift, prompt changes, or agent configurations?</p>

          <select name="D2_stability" required>
            <option value="" selected disabled>-- select --</option>
            <option>Stable (evaluated; low sensitivity)</option>
            <option>Mostly stable (some sensitivity; controls/monitoring in place)</option>
            <option>Unstable (material sensitivity; significant residual risk)</option>
            <option>Unknown / not assessed</option>
          </select>

          <label class="title" style="margin-top:10px;">D2 (Free-text). Sensitivity & Drift <span class="req">*</span></label>
          <textarea name="D2_detail" required placeholder="Describe known sensitivity to time, data, prompts, or agent configuration changes. Explain drift detection and response."></textarea>
        </div>

        <div class="q">
          <label class="title">D3. Ongoing Monitoring in Production? <span class="req">*</span></label>
          <p class="help">Is fairness monitored post-deployment?</p>

          <select name="D3_monitoring" required>
            <option value="" selected disabled>-- select --</option>
            <option>Yes (defined metrics, frequency, ownership, and alerts)</option>
            <option>Planned (not yet implemented)</option>
            <option>No (not monitored)</option>
            <option>Not applicable (explain)</option>
          </select>

          <div class="row two" style="margin-top:10px;">
            <div>
              <label class="title">D3 (Free-text). Monitoring Design <span class="req">*</span></label>
              <textarea name="D3_design" required placeholder="Describe monitoring metrics, cadence, thresholds, alerting/escalation, and responsible teams."></textarea>
            </div>
            <div>
              <label class="title">D3 (Optional). Monitoring Artifacts / Dashboard IDs</label>
              <textarea name="D3_evidence" placeholder="Provide internal links/IDs to dashboards, reports, or monitoring artifacts. One item per line."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- E -->
      <div class="card">
        <h2 class="section-title">E. Mitigation Controls & Human Oversight</h2>

        <div class="q">
          <label class="title">E1. Bias Mitigation Techniques Implemented <span class="req">*</span></label>
          <p class="help">Select all that apply.</p>

          <div class="checks cols2">
            <label class="check"><input type="checkbox" name="E1_mitigations" value="Data rebalancing/augmentation"><span>Data rebalancing or augmentation</span></label>
            <label class="check"><input type="checkbox" name="E1_mitigations" value="Feature exclusion/constraint"><span>Feature exclusion or constraint</span></label>
            <label class="check"><input type="checkbox" name="E1_mitigations" value="Fairness-aware optimization"><span>Model regularization or fairness-aware optimization</span></label>
            <label class="check"><input type="checkbox" name="E1_mitigations" value="Prompt controls"><span>Prompt engineering or system instruction controls</span></label>
            <label class="check"><input type="checkbox" name="E1_mitigations" value="Human-in-the-loop review"><span>Human-in-the-loop review</span></label>
            <label class="check"><input type="checkbox" name="E1_mitigations" value="Output filtering/policy enforcement"><span>Output filtering or policy enforcement</span></label>
            <label class="check"><input type="checkbox" name="E1_mitigations" value="Escalation/override mechanisms"><span>Escalation or override mechanisms</span></label>
            <label class="check"><input type="checkbox" id="E1_other_chk" name="E1_mitigations" value="Other"><span>Other (describe below)</span></label>
          </div>

          <div class="row two" style="margin-top:10px;">
            <div>
              <label class="title">E1 (Free-text). Mitigation Summary <span class="req">*</span></label>
              <textarea name="E1_summary" required placeholder="Describe which mitigations were applied, when, and why. Explain any trade-offs (e.g., accuracy vs fairness)."></textarea>
            </div>
            <div>
              <label class="title">E1 (Optional). Other Mitigation</label>
              <textarea name="E1_other_text" placeholder="If 'Other' selected above, describe it here."></textarea>
            </div>
          </div>
        </div>

        <div class="q">
          <label class="title">E2. Human Review & Escalation <span class="req">*</span></label>
          <p class="help">How are potential bias or fairness issues identified, reviewed, and escalated?</p>

          <select name="E2_oversight" required>
            <option value="" selected disabled>-- select --</option>
            <option>Strong oversight (defined roles, review steps, and escalation paths)</option>
            <option>Moderate oversight (some reviews; gaps exist)</option>
            <option>Limited oversight (ad hoc; undocumented)</option>
            <option>No formal oversight</option>
          </select>

          <label class="title" style="margin-top:10px;">E2 (Free-text). Oversight in Practice <span class="req">*</span></label>
          <textarea name="E2_detail" required placeholder="Describe how humans detect, challenge, and intervene when fairness concerns arise. Include how overrides are logged and reviewed."></textarea>
        </div>
      </div>

      <!-- F -->
      <div class="card">
        <h2 class="section-title">F. Governance, Validation & Accountability</h2>

        <div class="q">
          <label class="title">F1. Independent Fairness Review <span class="req">*</span></label>
          <p class="help">Has bias and fairness been independently assessed (e.g., by MRM, validation, compliance)?</p>

          <select name="F1_review" required>
            <option value="" selected disabled>-- select --</option>
            <option>Yes (completed; evidence available)</option>
            <option>In progress</option>
            <option>No (not performed)</option>
            <option>Not applicable (explain)</option>
          </select>

          <label class="title" style="margin-top:10px;">F1 (Free-text). Review Details <span class="req">*</span></label>
          <textarea name="F1_detail" required placeholder="Describe scope, reviewers (roles), timing, methodology, and conclusions. Include key issues and remediation status, if any."></textarea>
        </div>

        <div class="q">
          <label class="title">F2. Roles & Accountability <span class="req">*</span></label>
          <p class="help">Who is accountable for fairness risk management? Select all that apply.</p>

          <div class="checks cols3">
            <label class="check"><input type="checkbox" name="F2_roles" value="Model Owner"><span>Model Owner</span></label>
            <label class="check"><input type="checkbox" name="F2_roles" value="Business Owner"><span>Business Owner</span></label>
            <label class="check"><input type="checkbox" name="F2_roles" value="MRM / Model Validation"><span>MRM / Model Validation</span></label>
            <label class="check"><input type="checkbox" name="F2_roles" value="Compliance / Legal"><span>Compliance / Legal</span></label>
            <label class="check"><input type="checkbox" name="F2_roles" value="AI Governance Committee"><span>AI Governance Committee</span></label>
            <label class="check"><input type="checkbox" id="F2_other_chk" name="F2_roles" value="Other"><span>Other (describe below)</span></label>
          </div>

          <div class="row two" style="margin-top:10px;">
            <div>
              <label class="title">F2 (Free-text). Accountability Model <span class="req">*</span></label>
              <textarea name="F2_detail" required placeholder="Describe decision rights, approvals, and ongoing ownership (including who signs off on thresholds and exceptions)."></textarea>
            </div>
            <div>
              <label class="title">F2 (Optional). Other Role(s)</label>
              <textarea name="F2_other_text" placeholder="If 'Other' selected above, describe it here."></textarea>
            </div>
          </div>
        </div>

        <div class="q">
          <label class="title">F3. Documentation & Evidence Available <span class="req">*</span></label>
          <p class="help">Select all artifacts that exist today.</p>

          <div class="checks cols2">
            <label class="check"><input type="checkbox" name="F3_artifacts" value="Fairness / bias assessment report"><span>Fairness / bias assessment report</span></label>
            <label class="check"><input type="checkbox" name="F3_artifacts" value="Model/system card (fairness section)"><span>Model or system card (fairness section)</span></label>
            <label class="check"><input type="checkbox" name="F3_artifacts" value="Validation findings"><span>Validation findings</span></label>
            <label class="check"><input type="checkbox" name="F3_artifacts" value="Monitoring dashboards/metrics"><span>Monitoring dashboards or metrics</span></label>
            <label class="check"><input type="checkbox" name="F3_artifacts" value="Issue logs / remediation records"><span>Issue logs or remediation records</span></label>
            <label class="check"><input type="checkbox" name="F3_artifacts" value="Regulatory / audit summaries"><span>Regulatory or audit summaries</span></label>
            <label class="check"><input type="checkbox" name="F3_artifacts" value="None"><span>None</span></label>
          </div>

          <label class="title" style="margin-top:10px;">F3 (Optional). Evidence References</label>
          <textarea name="F3_evidence" placeholder="Provide links/IDs to documents in your repository (do not paste sensitive content). One item per line."></textarea>
        </div>
      </div>

      <div class="card">
        <h2 class="section-title">Submission</h2>
        <p class="help">
          Use <b>Save Draft</b> to store progress locally in this browser. <b>Submit</b> runs basic required-field checks and
          exports a JSON copy of your responses (download) to simulate submission.
        </p>
      </div>

      <div class="footerbar">
        <div class="inner">
          <div class="status" id="status">Draft not saved.</div>
          <button type="button" id="clearBtn">Clear</button>
          <button type="button" id="saveBtn">Save Draft</button>
          <button type="submit" class="primary" disabled disabled disabled>PRINT</button>
        </div>
      </div>
    </form>
  </div>

  
  <!-- PDF export dependencies (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
    // Pre-flight: ensure the Clear button works even if other scripts fail.
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("bf-form");
      const clearBtn = document.getElementById("clearBtn");
      const statusEl = document.getElementById("status");
      if (!form || !clearBtn) return;

      clearBtn.addEventListener("click", () => {
        try {
          // Clear storage (best-effort)
          try { localStorage.removeItem("bias_fairness_questionnaire_v1"); } catch (e) {}
          try { localStorage.removeItem("bias_fairness_draft"); } catch (e) {}

          // Reset built-in controls
          form.reset();

          // Hard reset for stubborn state (checkbox/radio/select/text)
          form.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(i => { i.checked = false; });
          form.querySelectorAll("select").forEach(sel => { sel.selectedIndex = 0; });
          form.querySelectorAll('input[type="text"], textarea').forEach(el => { el.value = ""; });

          if (statusEl) statusEl.textContent = "Cleared.";
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (err) {
          console.error("Clear failed:", err);
          if (statusEl) statusEl.textContent = "Clear failed. See console for details.";
        }
      });
    });
  </script>

  <script>
    // Pre-flight: Save Draft simulation (fills required fields with realistic example answers)
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("bf-form");
      const saveBtn = document.getElementById("saveBtn");
      const statusEl = document.getElementById("status");
      if (!form || !saveBtn) return;

      const nowStamp = () => new Date().toLocaleString();

      const mark = (el) => {
        try { el.classList.add("simulated-answer"); } catch (e) {}
      };

      const pickFirstNonEmpty = (sel) => {
        const opts = Array.from(sel.options || []);
        const found = opts.find(o => (o.value ?? "") !== "");
        return found ? found.value : (opts[0] ? opts[0].value : "");
      };

      const chooseByKeyword = (optionsLike, keywords) => {
        const opts = Array.from(optionsLike || []);
        const lower = opts.map(o => ({
          v: (o.value || "").toLowerCase(),
          t: (o.textContent || "").toLowerCase(),
          val: o.value
        }));
        for (const kw of (keywords || [])) {
          const k = kw.toLowerCase();
          const hit = lower.find(x => x.v.includes(k) || x.t.includes(k));
          if (hit) return hit.val;
        }
        return null;
      };

      const rationaleTemplate = (topic) => {
        const base =
          "Rationale: Based on the use case and governance expectations, the selections below are intended to be auditable, " +
          "repeatable, and proportionate to risk. We considered subgroup outcomes, potential proxy variables, and operational " +
          "impacts, and selected metrics/thresholds aligned to policy and applicable regulatory guidance. Monitoring includes " +
          "defined triggers, accountable owners, and documented remediation steps.";
        return topic ? (base + "\n\nNotes: " + topic) : base;
      };

      function simulateRequiredSelects() {
        form.querySelectorAll("select[required]").forEach(sel => {
          if (sel.value) return;

          const preferred = chooseByKeyword(sel.options, [
            "yes", "in use", "high", "medium", "low",
            "monthly", "quarterly", "annually",
            "disparate impact", "demographic parity", "equalized odds", "equal opportunity",
            "accuracy", "auc", "f1", "precision", "recall",
            "psi", "ks", "drift",
            "human", "review", "approval"
          ]);

          sel.value = preferred ?? pickFirstNonEmpty(sel);
          mark(sel);
          sel.dispatchEvent(new Event("change", { bubbles: true }));
        });
      }

      function simulateCheckboxesAndRadios() {
        // Goal: ensure checkbox/radio questions marked with a visible "*" (span.req) get at least one selection.
        // Many checkbox groups in this form are "required" by UX, but the inputs are not marked with the HTML required attribute.

        // 1) Handle any groups that ARE marked required at the input level (by name)
        const req = form.querySelectorAll('input[type="checkbox"][required], input[type="radio"][required]');
        const names = new Set(Array.from(req).map(x => x.name).filter(Boolean));

        names.forEach(name => {
          const group = form.querySelectorAll(`input[name="${name}"]`);
          if (!group.length) return;
          if (Array.from(group).some(x => x.checked)) return;

          let chosen =
            Array.from(group).find(x => (x.value || "").toLowerCase() === "yes") ||
            group[0];

          if (chosen) {
            chosen.checked = true;
            chosen.dispatchEvent(new Event("change", { bubbles: true }));
          }
        });

        // 2) For questions with a visible required "*" (span.req), ensure at least one checkbox/radio is selected
        const requiredQs = form.querySelectorAll(".q");
        requiredQs.forEach(q => {
          const hasStar = !!q.querySelector("label .req, label.title .req, .title .req");
          if (!hasStar) return;

          const inputs = q.querySelectorAll('input[type="checkbox"], input[type="radio"]');
          if (!inputs.length) return;

          const anyChecked = Array.from(inputs).some(i => i.checked);
          if (anyChecked) return;

          // Choose first meaningful option (prefer non-"Other" if possible)
          let chosen = Array.from(inputs).find(i => {
            const v = (i.value || "").toLowerCase();
            const id = (i.id || "").toLowerCase();
            return !v.includes("other") && !id.includes("other");
          }) || inputs[0];

          chosen.checked = true;
          chosen.dispatchEvent(new Event("change", { bubbles: true }));

          // Make the selected option's label text appear blue (simulated)
          const lab = chosen.closest("label");
          if (lab) lab.classList.add("simulated-answer");
        });

        // 3) Fallback: required inputs without a name
        form.querySelectorAll('input[type="checkbox"][required]:not([name]), input[type="radio"][required]:not([name])')
          .forEach((inp) => {
            if (!inp.checked) {
              inp.checked = true;
              inp.dispatchEvent(new Event("change", { bubbles: true }));
              const lab = inp.closest("label");
              if (lab) lab.classList.add("simulated-answer");
            }
          });
      }

      function simulateRequiredTextInputs() {
        form.querySelectorAll('input[type="text"][required]').forEach(inp => {
          if (inp.value && inp.value.trim()) return;
          inp.value = "See documented rationale and supporting evidence.";
          mark(inp);
          inp.dispatchEvent(new Event("input", { bubbles: true }));
        });
      }

      function simulateRequiredTextareas() {
        form.querySelectorAll("textarea[required]").forEach((ta, idx) => {
          if (ta.value && ta.value.trim()) return;

          const topic =
            idx === 0 ? "Fairness objective is to avoid unjustified differences across protected groups while maintaining utility."
            : idx === 1 ? "Data review confirms coverage for key segments; known gaps are documented with mitigations."
            : idx === 2 ? "Primary metrics include subgroup error-rate parity and disparate impact ratio with policy-aligned thresholds."
            : "Monitoring includes periodic subgroup checks, drift alerts, and escalation/mitigation playbooks.";

          ta.value = rationaleTemplate(topic);
          mark(ta);
          ta.dispatchEvent(new Event("input", { bubbles: true }));
        });
      }

      function simulateFillAllRequired() {
        simulateRequiredSelects();
        simulateCheckboxesAndRadios();
        simulateRequiredTextInputs();
        simulateRequiredTextareas();
      }

      saveBtn.addEventListener("click", () => {
        try {
          simulateFillAllRequired();
          try { localStorage.setItem("bias_fairness_simulated_draft", JSON.stringify({ saved_at: new Date().toISOString() })); } catch (e) {}
          if (statusEl) statusEl.textContent = "Draft populated with sample answers: " + nowStamp();
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (err) {
          console.error("Save Draft simulation failed:", err);
          if (statusEl) statusEl.textContent = "Save Draft failed. See console for details.";
        }
      });
    });
  </script>

  <script>
    // Pre-flight: PRINT gating + PDF download (works even if later scripts error)
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("bf-form");
      const statusEl = document.getElementById("status");
      const printBtn = form ? form.querySelector('button[type="submit"]') : null;
      if (!form || !printBtn) return;

      // Always start disabled; enable only when required questions are complete.
      printBtn.disabled = true;

      const hasStar = (q) => !!q.querySelector(".req");

      const isInputFilled = (el) => {
        if (!el) return true;
        const tag = el.tagName;
        const type = (el.type || "").toLowerCase();

        if (type === "checkbox" || type === "radio") {
          // group requirement by name if present, else by container
          if (el.name) {
            const group = form.querySelectorAll(`input[name="${CSS.escape(el.name)}"]`);
            return Array.from(group).some(x => x.checked);
          }
          return el.checked;
        }
        if (tag === "SELECT") return (el.value ?? "") !== "";
        return ((el.value ?? "").trim().length > 0);
      };

      const isQuestionCompleted = (q) => {
        // If question has visible star, treat as required even if HTML required attr is missing
        const starred = hasStar(q);

        // 1) Any explicitly required elements inside must be filled
        const reqEls = q.querySelectorAll("[required]");
        for (const el of reqEls) {
          if (!isInputFilled(el)) return false;
        }

        if (!starred) return true; // only enforce [required] unless starred

        // 2) For starred questions: enforce at least one meaningful answer within the question block
        const checks = q.querySelectorAll('input[type="checkbox"], input[type="radio"]');
        if (checks.length) {
          return Array.from(checks).some(c => c.checked);
        }

        const selects = q.querySelectorAll("select");
        if (selects.length) {
          return Array.from(selects).every(s => (s.value ?? "") !== "");
        }

        const texts = q.querySelectorAll('input[type="text"], textarea');
        if (texts.length) {
          // Some starred blocks have multiple text areas; require the starred one(s) be filled.
          return Array.from(texts).every(t => ((t.value ?? "").trim().length > 0));
        }

        // If no recognizable inputs, don't block printing
        return true;
      };

      const updatePrintButtonState = () => {
        const questions = form.querySelectorAll(".q");
        const allOk = Array.from(questions).every(isQuestionCompleted);
        printBtn.disabled = !allOk;
      };

      // Listen to changes on the whole form
      form.addEventListener("input", updatePrintButtonState, true);
      form.addEventListener("change", updatePrintButtonState, true);

      // Initial state (covers case where Save Draft loads/fills quickly)
      setTimeout(updatePrintButtonState, 0);

      // PRINT -> generate PDF download
      printBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        updatePrintButtonState();
        if (printBtn.disabled) {
          if (statusEl) statusEl.textContent = "Please complete all required fields before printing.";
          return;
        }

        if (statusEl) statusEl.textContent = "Preparing PDF…";

        // --- Prepare page for clean PDF capture ---
        const prevScrollY = window.scrollY;
        const active = document.activeElement;
        if (active && active.blur) active.blur();

        // Add capture mode (hides buttons/status via CSS)
        document.body.classList.add("pdf-mode");

        // Auto-expand textareas so long lines aren't clipped
        const textareas = Array.from(document.querySelectorAll("textarea"));
        const taPrev = textareas.map(ta => ({
          el: ta,
          height: ta.style.height,
          overflow: ta.style.overflow,
          whiteSpace: ta.style.whiteSpace
        }));
        textareas.forEach(ta => {
          // Force wrap-friendly rendering and expand height
          ta.style.whiteSpace = "pre-wrap";
          ta.style.overflow = "visible";
          ta.style.height = "auto";
          ta.style.height = (ta.scrollHeight + 4) + "px";
        });

        // Scroll to the very top so header/title/instructions are included
        window.scrollTo(0, 0);

        try {
          // Capture the main form area (including header/title).
          // Prefer the top-level container; fall back to body.
          const target =
            document.querySelector(".container") ||
            document.querySelector("main") ||
            document.body;

          const canvas = await html2canvas(target, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff",
            scrollX: 0,
            scrollY: 0,
            windowWidth: document.documentElement.clientWidth,
            windowHeight: document.documentElement.clientHeight
          });

          const imgData = canvas.toDataURL("image/png");
          const { jsPDF } = window.jspdf;

          const pdf = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();

          const imgWidth = pageWidth;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          let remaining = imgHeight;
          pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);

          while (remaining > pageHeight) {
            remaining -= pageHeight;
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 0, -(imgHeight - remaining), imgWidth, imgHeight);
          }

          const stamp = new Date().toISOString().slice(0, 10);
          pdf.save(`bias_fairness_questionnaire_${stamp}.pdf`);

          if (statusEl) statusEl.textContent = "PDF downloaded.";
        } catch (err) {
          console.error("PDF generation failed:", err);
          if (statusEl) statusEl.textContent = "PDF generation failed. See console for details.";
        } finally {
          // Restore textarea styles
          taPrev.forEach(x => {
            x.el.style.height = x.height;
            x.el.style.overflow = x.overflow;
            x.el.style.whiteSpace = x.whiteSpace;
          });

          // Remove capture mode and restore scroll
          document.body.classList.remove("pdf-mode");
          window.scrollTo(0, prevScrollY);
        }
      });
    });
  </script>




<script>
    const FORM_KEY = "bias_fairness_questionnaire_v1";
    const form = document.getElementById("bf-form");
    const statusEl = document.getElementById("status");

    function nowStamp() {
      const d = new Date();
      return d.toLocaleString();
    }

    function formToJSON(formEl) {
      const data = {};
      const fd = new FormData(formEl);

      // collect multi-value fields (checkbox groups) properly
      for (const [k, v] of fd.entries()) {
        if (data[k] === undefined) data[k] = v;
        else if (Array.isArray(data[k])) data[k].push(v);
        else data[k] = [data[k], v];
      }

      // ensure unchecked checkboxes still appear as empty arrays (for known groups)
      const groups = [
        "A1_objectives","A2_groups","B3_sources","C1_defs","C3_scope",
        "E1_mitigations","F2_roles","F3_artifacts"
      ];
      groups.forEach(g => {
        if (data[g] === undefined) data[g] = [];
        if (!Array.isArray(data[g])) data[g] = [data[g]];
      });

      return data;
    }

    function jsonToForm(formEl, data) {
      // reset first
      formEl.reset();

      // set simple fields
      for (const [k, v] of Object.entries(data || {})) {
        const els = formEl.querySelectorAll(`[name="${CSS.escape(k)}"]`);
        if (!els || els.length === 0) continue;

        // checkbox groups
        if (els[0].type === "checkbox") {
          const values = Array.isArray(v) ? v : [v];
          els.forEach(el => { el.checked = values.includes(el.value); });
          continue;
        }

        // selects/textareas/inputs
        els.forEach(el => { el.value = v; });
      }
    }

      const stamp = new Date(submission.submitted_at).toISOString().slice(0,10);
      pdf.save(`bias_fairness_questionnaire_submission_${stamp}.pdf`);
    }


    
    async function exportCurrentViewPDF() {
      // Capture the visible questionnaire content as-is and save to PDF (client-side).
      const el = document.querySelector(".container") || document.body;

      // Ensure we are at the top so headers are included
      try { window.scrollTo(0, 0); } catch (e) {}

      // Render element to canvas
      const canvas = await html2canvas(el, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff",
        windowWidth: document.documentElement.scrollWidth,
        windowHeight: document.documentElement.scrollHeight,
        scrollX: 0,
        scrollY: -window.scrollY
      });

      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;

      const pdf = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgWidth = pageWidth;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let remaining = imgHeight;

      // Add first page
      pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);

      // Add additional pages as needed by shifting the same image upward
      while (remaining > pageHeight) {
        remaining -= pageHeight;
        pdf.addPage();
        pdf.addImage(imgData, "PNG", 0, -(imgHeight - remaining), imgWidth, imgHeight);
      }

      const stamp = new Date().toISOString().slice(0,10);
      pdf.save(`bias_fairness_questionnaire_${stamp}.pdf`);
    }


    
    // -------------------------------
    // Completion gating for PRINT
    // -------------------------------
    function isFieldCompleted(el) {
      // Treat checkbox/radio as a group requirement by name
      if (el.type === "checkbox" || el.type === "radio") {
        const group = form.querySelectorAll(`input[name="${CSS.escape(el.name)}"]`);
        return Array.from(group).some(x => x.checked);
      }
      if (el.tagName === "SELECT") {
        return el.value !== "";
      }
      return (el.value ?? "").trim().length > 0;
    }

    function updatePrintButtonState() {
      const required = form.querySelectorAll("[required]");
      const allDone = required.length > 0 && Array.from(required).every(isFieldCompleted);
      const printBtn = form.querySelector('button[type="submit"]');
      if (printBtn) printBtn.disabled = !allDone;
    }

    function attachCompletionListeners() {
      // Start disabled no matter what; we'll enable once validation passes
      const printBtn = form.querySelector('button[type="submit"]');
      if (printBtn) printBtn.disabled = true;

      const required = form.querySelectorAll("[required]");
      required.forEach(el => {
        el.addEventListener("change", updatePrintButtonState);
        el.addEventListener("input", updatePrintButtonState);
      });

      updatePrintButtonState();
    }

    // -------------------------------
    // Save Draft: simulate completion
    // -------------------------------
    function pickFirstNonEmptyOption(selectEl) {
      for (let i = 0; i < selectEl.options.length; i++) {
        const opt = selectEl.options[i];
        if ((opt.value ?? "") !== "") return opt.value;
      }
      return "";
    }

    function fillRationale(ta, hint) {
      const base =
        "Rationale: Based on the stated use case, the defined protected groups, and observed data characteristics, " +
        "we selected fairness definitions and metrics aligned to policy and applicable regulatory expectations. " +
        "Testing includes baseline evaluation, subgroup performance review, and ongoing monitoring triggers. " +
        "Mitigations and human oversight are documented with clear ownership, thresholds, and audit-ready evidence.";
      ta.value = hint ? (base + "\n\n" + hint) : base;
    }

    function simulateFormFill() {
      // 1) Required selects
      form.querySelectorAll("select[required]").forEach(sel => {
        if (!sel.value) sel.value = pickFirstNonEmptyOption(sel);
      });

      // 2) Required checkbox/radio groups: ensure at least one checked per group
      const requiredChecks = form.querySelectorAll('input[type="checkbox"][required], input[type="radio"][required]');
      const names = new Set(Array.from(requiredChecks).map(i => i.name));
      names.forEach(name => {
        const group = form.querySelectorAll(`input[name="${CSS.escape(name)}"]`);
        if (!Array.from(group).some(x => x.checked)) {
          // Prefer a non-empty value option if present
          const candidate = Array.from(group).find(x => (x.value ?? "") !== "") || group[0];
          if (candidate) candidate.checked = true;
        }
      });

      // 3) Required text inputs
      form.querySelectorAll('input[type="text"][required]').forEach(inp => {
        if (!inp.value || !inp.value.trim()) inp.value = "See documented rationale and supporting evidence.";
      });

      // 4) Required textareas: realistic governance-friendly rationale
      form.querySelectorAll("textarea[required]").forEach((ta, idx) => {
        if (!ta.value || !ta.value.trim()) {
          // Add a slightly different hint per textarea to look more realistic
          const hint =
            idx === 0 ? "Key considerations: sample representativeness, proxy variables, and disparate impact risk."
            : idx === 1 ? "Key considerations: threshold selection, confidence intervals, and action plans for breaches."
            : "Key considerations: documentation, sign-offs, and evidence retention for audit/regulatory review.";
          fillRationale(ta, hint);
        }
      });
    }

    function saveDraft() {
      simulateFormFill();

      const payload = {
        saved_at: new Date().toISOString(),
        data: formToJSON(form)
      };
      localStorage.setItem(FORM_KEY, JSON.stringify(payload));

      statusEl.textContent = "Draft populated and saved: " + new Date(payload.saved_at).toLocaleString();
      updatePrintButtonState();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function loadDraft() {
      const raw = localStorage.getItem(FORM_KEY);
      if (!raw) return;
      try {
        const payload = JSON.parse(raw);
        if (payload && payload.data) {
          jsonToForm(form, payload.data);
          statusEl.textContent = "Draft loaded (saved: " + new Date(payload.saved_at).toLocaleString() + ")";
        }
      } catch (e) {
        console.warn("Failed to load draft:", e);
      } finally {
        updatePrintButtonState();
      }
    }

    function clearDraftAndForm() {
      // Always clear without relying on reset quirks
      localStorage.removeItem(FORM_KEY);
      form.reset();

      // Explicitly clear checkboxes/radios in case browser retains state
      form.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(i => { i.checked = false; });

      // Explicitly reset selects to placeholder/first option
      form.querySelectorAll("select").forEach(sel => {
        sel.selectedIndex = 0;
      });

      // Clear text inputs/textareas
      form.querySelectorAll('input[type="text"], textarea').forEach(el => { el.value = ""; });

      statusEl.textContent = "Cleared.";
      updatePrintButtonState();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Wire buttons
    document.getElementById("saveBtn").addEventListener("click", saveDraft);
    document.getElementById("clearBtn").addEventListener("click", clearDraftAndForm);

    // Init
    window.addEventListener("DOMContentLoaded", () => {
      attachCompletionListeners();
      loadDraft();
    });



form.addEventListener("submit", async (e) => {
      
      
      e.preventDefault();

      // If the form uses native required fields, enforce them before exporting.
      // reportValidity() shows the browser's validation UI.
      if (typeof form.reportValidity === "function" && !form.reportValidity()) return;

      statusEl.textContent = "Preparing to save PDF...";
      const printBtn = form.querySelector('button[type="submit"]');
      if (printBtn) { printBtn.disabled = true; printBtn.textContent = "Working…"; }

      try {
        await exportCurrentViewPDF();
        statusEl.textContent = "PDF saved.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Could not generate PDF. Please try again.";
        if (printBtn) { printBtn.disabled = false; printBtn.textContent = "PRINT"; }
        return;
      }

      // Attempt to close the tab (may be blocked unless opened by script)
      setTimeout(() => {
        try { window.close(); } catch (e) {}
      }, 400);


    });

    // Auto-save on change (lightweight)
    let autosaveTimer = null;
    form.addEventListener("input", () => {
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        localStorage.setItem(FORM_KEY, JSON.stringify({
          saved_at: new Date().toISOString(),
          data: formToJSON(form)
        }));
        statusEl.textContent = "Auto-saved: " + nowStamp();
      }, 650);
    });

    loadDraft();
  </script>
</body>
</html>
